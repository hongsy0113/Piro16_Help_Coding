{% extends 'base.html' %}

{% block title %}
    {{ question.title }} | ë„ì™€ì¤˜, ì½”ë”©
{% endblock %}

{% load static %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/detail.css' %}">
{% endblock css %}

{% load hitcount_tags %}

{% block js %}
<script type="text/javascript" src="/static/js/qna_detail.js" defer></script>
{% endblock %}

{% block content %}
{{ request.user.id|json_script:"user_id" }}
{{ question.id|json_script:"question_id" }}
<main>
    <h1>{{ question.title }}</h1>
    <div style="display: flex; justify-content: space-between;">
        <!-- js ì—ì„œ question infoë¥¼ split í•˜ëŠ”ë°, í•œ ì¤„ì— ì•ˆ ì“°ë©´ ê³µë°±ì´ ë“¤ì–´ê°€ë¯€ë¡œ í•œ ì¤„ë¡œ ì¨ì•¼ í•¨ -->
        <p class = "question__info ">{{ question.created_at|date:'y.m.d'}} Â· ì¡°íšŒ {% get_hit_count for question %} Â· ì¢‹ì•„ìš” {{ total_likes }} Â· <a href="{% if question.user %}{% url 'user:public_userpage' question.user.pk %}{% endif %}" style="text-decoration: none; color:#212529;">{{ username }}</a></p>
        <p>
            {% if question.user.id == user.id and user.is_authenticated %}
            <a href="{% url 'qna:question_update' question.pk %}" class="question__edit-btn">ìˆ˜ì •</a>
                {% if answers_count > 0 %}
                <a class="question__delete-btn" onclick="alert('ë‹µë³€ì´ ë‹¬ë ¤ ìˆì–´ì„œ ì‚­ì œí•  ìˆ˜ ì—†ì–´ìš”ğŸ¥º')">ì‚­ì œ</a>      
                {% else %}
                <span class="question__delete-btn question__delete-btn--actual">ì‚­ì œ</span>      
                {% endif %}
            {% endif %}
        </p>
    </div>
    <div class="question__detail__tagcontainer">
        {% if question.s_or_e_tag == 'S' %}
        <a href="{% url 'qna:question_list' %}?tag_filter_by=S">
            <div class="question__detail__tag question__detail__scratchtag">ìŠ¤í¬ë˜ì¹˜</div>
        </a>
        {% elif question.s_or_e_tag == 'E' %}
        <a href="{% url 'qna:question_list' %}?tag_filter_by=E">
            <div class="question__detail__tag question__detail__entrytag">ì—”íŠ¸ë¦¬</div>
        </a>
        {% else %}
        <a href="{% url 'qna:question_list' %}?tag_filter_by=ETC">
            <div class="question__detail__tag question__detail__etctag">ê¸°íƒ€</div>
        </a>
        {% endif %}
        
        {% for tag in tags %}
        <a href="{% url 'qna:search_result' %}?search={{ tag.tag_name }}">
            <div class="question__detail__tag">
                {{ tag.tag_name }}
            </div>
        </a>
        {% endfor %}
    </div>
    <hr>
    <div class="question__detail__content">
        <p>{{ question.content }}</p>
        
        {% if question.image %}<img src="{{ question.image.url }}">{% endif %}
        
        {% if question.attached_file %}
        <div class="detail__content--attached_file">
            <div class="attached_file--left">
                <label>ì²¨ë¶€íŒŒì¼</label>
                <div>{{ question.get_filename }}</div>
            </div>
            <form action="{% url 'qna:download' question.id %}">
                <button type="submit">
                    ë‹¤ìš´ë¡œë“œ
                </button>
            </form>
        </div>
        {% endif %}
        <div class="question__like-btn">
            {% if is_liked %}
            <i class="fas fa-heart"></i>
            {% else %}
            <i class="far fa-heart"></i>
            {% endif %}
            <span>{{ total_likes }}</span>
        </div>
    </div>
        
    <hr>

    <div class="question__buttons">
        <a href="{% url 'qna:question_list' %}" class="question__list-btn">ëª©ë¡ë³´ê¸°</a>
        {% if previous_pk != -1 %}
        <span style="color: #828282;"> Â· </span>
        <a href="{% url 'qna:question_detail' previous_pk %}" class="question__prev-btn">ì´ì „ê¸€</a>
        {% endif %}
        {% if next_pk != -1 %}
        <span style="color: #828282;"> Â· </span>
        <a href="{% url 'qna:question_detail' next_pk %}" class="question__next-btn">ë‹¤ìŒê¸€</a>
        {% endif %}
    </div>
    <hr>
    
    
    <div class="answer__input__container">
        <textarea name="new_answer" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" class="answer__input";></textarea>  
        <input type="button" value = "ë“±ë¡" class="answer__submit">
    </div>

    <p class="answer__total-count" style="font-weight: bold; font-size: 18px; line-height: 150%; color: black;">ë‹µë³€ {{ answers_count }} ê°œ </p>

    <div class="answer__list">
        <!-- ë‹µë³€ ë¶€ë¶„ -->
        {% for answer, replies in answers_reply_dict.items %}
            <div class="answer__container answer__container--{{ answer.id }}" id="answer-id-{{ answer.id }}">
                <div class="answer__content-container answer__content-container--{{ answer.id }}">
                    <div class="answer__user__profile">
                        <div class="answer__user__profile-left">
                            {% if answer.user.img %}
                            <img src= '{{ answer.user.img.url }}'>
                            {% endif %}
                        </div>
                        <div class="answer__user__profile-right">
                            <div> <!-- ì´ë¦„, ê¸€ì“´ì´, ë‚ ì§œ -->
                                <div class="answer__user__name answer__user__name--{{ answer.id }}">
                                    {% if answer.user %}
                                    <h2><a href="{% url 'user:public_userpage' answer.user.pk %}" style="text-decoration: none; color:#212529;">{{ answer.user }}</a></h2>
                                    {% if answer.user.id == question.user.id %}
                                    <span class="answer__writer-mark">ê¸€ì“´ì´</span>
                                    {% endif %}
                                    {% else %}
                                    <h2>(ì•Œ ìˆ˜ ì—†ìŒ)</h2>
                                    {% endif %}
                                </div>
                                <p>{{ answer.created_at|date:'y.m.d  H:i'}}</p>
                            </div>
                            {% if answer.user.id == user.id %}
                            <div>
                                <button class="answer__edit-btn answer__edit-btn--{{ answer.id }} " id="answer-edit-btn-{{ answer.id }}">ìˆ˜ì •</button>
                                <button class="answer__delete-btn answer__delete-btn--{{ answer.id }} " id="answer-delete-btn-{{ answer.id }}">ì‚­ì œ</button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <p class="answer__content answer__content--{{ answer.id }}">{{ answer.content }}</p>
                    <div class="answer__like__reply">
                        <div>
                            <input type="checkbox" class="answer__write-reply answer__write-reply--{{ answer.id }} btn-check " id="reply-btn-{{ answer.id }}" autocomplete="off">
                            <label class="answer__reply-btn" for="reply-btn-{{ answer.id }}">ë‹µê¸€ ì‘ì„±</label>
                        </div>
                        <div class="answer__like-btn answer__like-btn--{{ answer.id }}"  id="answer-like-{{ answer.id }}">
                            {% if user in answer.like_user.all %}
                            <i class="fas fa-heart"></i>
                            {% else %}
                            <i class="far fa-heart"></i>
                            {% endif %}
                            <span>{{ answer.like_user.all | length }}</span>
                        </div>
                    </div>
                </div>

                <div class="answer__edit answer__edit--{{ answer.id }}" style=" display: none;">
                    <div class="answer__edit__flexbox">
                        <textarea name="edit_answer_{{ answer.id }}" class="answer__edit-input answer__edit-input--{{ answer.id }}" id = "answer-edit-input-{{ answer.id }}" value="{{ answer.content }}"></textarea>
                        <input type="button" value = "ìˆ˜ì •" class="answer__edit-submit answer__edit-submit--{{ answer.id }}" id = "answer-edit-submit-{{ answer.id }}">
                    </div>
                </div>

                <div class="reply__list reply__list--{{ answer.id }} ">
                    <!-- ëŒ€ëŒ“ê¸€ ë¶€ë¶„ -->
                    {% for reply in replies %}
                        <div class="reply__container reply__container--{{reply.id}} answer__container--{{ reply.id }} ">
                            <div class="answer__content-container answer__content-container--{{ reply.id }}">
                                <div class="answer__user__profile">
                                    <div class="answer__user__profile-left">
                                        {% if reply.user.img %}
                                        <img src= '{{ reply.user.img.url }}'>
                                        {% endif %}
                                    </div>
                                    <div class="answer__user__profile-right">
                                        <div>
                                            <div class="answer__user__profile-name">
                                                {% if reply.user %}
                                                <h2><a href="{% url 'user:public_userpage' reply.user.pk %}" style="text-decoration: none; color:#212529;">{{ reply.user }}</a></h2>
                                                {% if reply.user.id == question.user.id %}
                                                <span class="answer__writer-mark">ê¸€ì“´ì´</span>
                                                {% endif %}
                                                {% else %}
                                                <h2>(ì•Œ ìˆ˜ ì—†ìŒ)</h2>
                                                {% endif %}
                                            </div>
                                            <p>{{ reply.created_at|date:'y.m.d  H:i' }}</p>
                                        </div>
                                        {% if reply.user.id == user.id %}
                                        <div>
                                            <button class="answer__edit-btn answer__edit-btn--{{ reply.id }} " id="answer-edit-btn-{{ reply.id }}">ìˆ˜ì •</button>
                                            <button class="answer__delete-btn answer__delete-btn--{{ reply.id }} " id="answer-delete-btn-{{ reply.id }}">ì‚­ì œ</button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class= "answer__content answer__content--{{ reply.id }}"> {{ reply.content }}</p>
                                <div class="answer__like-btn answer__like-btn--{{ reply.id }}" id="reply-like-{{ reply.id }}" style="align-self:flex-end">
                                    {% if user in reply.like_user.all %}
                                    <i class="fas fa-heart"></i>
                                    {% else %}
                                    <i class="far fa-heart"></i>
                                    {% endif %}
                                    <span>{{ reply.like_user.all | length }}</span>
                                </div>

                            </div>

                            <div class="answer__edit answer__edit--{{ reply.id }}" style=" display: none;">
                                <div class="answer__edit__flexbox">
                                    <input type="text" name="edit_answer_{{ reply.id }}" class="answer__edit-input answer__edit-input--{{ reply.id }}" id = "answer-edit-input-{{ reply.id }}" 
                                    value="{{ reply.content }}">    
                                    <input type="button" value = "ìˆ˜ì •" class="answer__edit-submit answer__edit-submit--{{ reply.id }}" id = "answer-edit-submit-{{ reply.id }}">
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="reply__form reply__form--{{ answer.id }}" style="display: none;">
                    <div class="reply__form__flexbox">
                        {% if user.is_authenticated %}
                        <input type="text" name="new_reply_{{ answer.id }}" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" class="reply__input reply__input--{{ answer.id }}" id = "reply-input-{{ answer.id }}">    
                        <input type="button" value = "ì‘ì„±" class="reply__submit reply__submit--{{ answer.id }}" id = "reply-submit-{{ answer.id }}">
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>


</main>
{% endblock %}
